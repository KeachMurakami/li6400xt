---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

## Installation

**The present version does not support Windows.**
You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("KeachMurakami/li6400xt")
```
## core function

Load data using `read_licor`.
Note that file must be tab-separated *text*, not *xls* automatically generated by the LI6400XT system.

```{r loading}
library(li6400xt)

library(tidyverse)
library(patchwork)

file <- system.file("light_curve.txt", package = "li6400xt")

mydata <- read_licor(file)
print(mydata)

net_photosynthesis <-
  mydata %>%
  ggplot(aes(time, Photo, col = PARi)) +
  geom_line() +
  scale_color_viridis_c()
stomatal_conductance <- 
  mydata %>%
  ggplot(aes(time, Cond, col = PARi)) +
  geom_line() +
  scale_color_viridis_c()

net_photosynthesis / stomatal_conductance

mydata %>%
  ggplot(aes(PARi, Photo, col = PARi)) +
  geom_point() +
  geom_smooth() +
  scale_color_viridis_c()
```



## miscellaneous functions

File remark and operational change logs are available as `attributes`.

```{r attributes}
# check remark noted on file creation
attributes(mydata)$remark

# check operational change logs
attributes(mydata)$control
```


Chamber environments usually fluctuate, making the analysis bothersome.
Use `track_changes` to add a column showing set-point values.

```{r track_changes}
mydata %>%
  track_changes(track = "LCF", variable = "PPFD") %>%
  ggplot(aes(time, PARi)) +
  geom_point() +
  geom_line(aes(y = PPFD), col = "orange")
```

- `track = LCF`: tracks changes in PARi
- <WIP> `track = XXX`: tracks change in CO2
- <WIP> `track = XXX`: tracks change in Tair/Tleaf




Leaves are not always broad enough to cover the chamber (e.g. wheat and rice).
Use `correct_leaf_area` to calculate leaf area sandwitched by the chamber.
This function calculates corrected `Area`, `Photo`, `Cond`, and `Trmmol` from given leaf width (`width_mm`) and chamber model (`model`).

```{r correct_leaf_area}
# Original area
mydata$Area[1]

# Corrected area
corrected_mydata <- correct_leaf_area(mydata, width_mm = 15, model = "6400-40")
corrected_mydata$Area[1]
```




## standard workflow

```r
data_of_multiple_leaves <-
  dir("PATH_TO_LI6400XT_DIR") %>%
  purrr::map(function(file){
    
    # read file
    data <- read_licor(file)
    
    # get leaf width from file remark
    width <- readr::parse_number(attributes(data)$remark)
    
    # correct area and track PPFD change
    data %>%
      correct_leaf_area(width_mm = width, model = "6400-40") %>%
      track_changes(track = "LCF", variable = "PPFD") %>%
      return()
  })
```
